name: Build Docker Image (Prod)

on:
  workflow_dispatch:

jobs:
  docker:
    name: Build and push Docker image
    runs-on: [self-hosted, prod, photography-website]
    environment: Prod
    steps:
      - name: Build and push Docker image
        if: vars.DOCKERHUB_USERNAME && vars.DOCKER_IMAGE_NAME
        run: |
          cd /home/ted/photography-website/

          # Login to Docker Hub
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ vars.DOCKERHUB_USERNAME }}" --password-stdin

          # Set tag (use environment variable or default to 'latest')
          TAG="${{ vars.DOCKER_TAG }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          # Build and push
          docker build -t ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG .
          docker push ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG

          # Also tag and push with commit hash
          COMMIT_HASH=$(git rev-parse --short HEAD)
          docker tag ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG \
                     ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$COMMIT_HASH
          docker push ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$COMMIT_HASH

          # Logout
          docker logout

      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TAG="${{ vars.DOCKER_TAG }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          MESSAGE="üê≥ Docker image built and pushed!

          üåê Branch: master
          üì¶ Image: ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG
          üè∑Ô∏è Also tagged: $COMMIT_HASH

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)

          MESSAGE="‚ùå Docker build FAILED!

          üåê Branch: master
          üì¶ Commit: $COMMIT_HASH

          ‚ö†Ô∏è PRODUCTION DOCKER BUILD FAILED!
          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true
