name: Update Devel VM

on:
  push:
    branches: [devel]
  workflow_dispatch:
    inputs:
      build_docker:
        description: "Build and push Docker image"
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Run update.sh on devel VM
    runs-on: [self-hosted, dev, photography-website]
    environment: Dev
    steps:
      - name: Pull latest changes from GitHub
        run: |
          cd /home/ted/photography-website/
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          git fetch origin "$CURRENT_BRANCH"
          git reset --hard "origin/$CURRENT_BRANCH"

      - name: Send deployment start notification
        if: vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="üîÑ Starting deployment...

          üåê Branch: devel
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Run deployment script
        run: |
          cd /home/ted/photography-website/
          ./restart.sh

      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="‚úÖ Photography Website deployed successfully!

          üåê Branch: devel
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="‚ùå Photography Website deployment FAILED!

          üåê Branch: devel
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

  docker:
    name: Build and push Docker image
    runs-on: [self-hosted, dev, photography-website]
    environment: Docker-Build-Dev
    needs: deploy
    steps:
      - name: Send Docker build start notification
        if: vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)

          MESSAGE="üê≥ Docker build starting...

          üåê Branch: devel
          üì¶ Commit: $COMMIT_HASH

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Build and push Docker image
        if: vars.DOCKERHUB_USERNAME && vars.DOCKER_IMAGE_NAME
        run: |
          cd /home/ted/photography-website/

          # Login to Docker Hub
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ vars.DOCKERHUB_USERNAME }}" --password-stdin

          # Set tag (use environment variable or default to 'dev')
          TAG="${{ vars.DOCKER_TAG }}"
          if [ -z "$TAG" ]; then
            TAG="dev"
          fi

          # Build and push with dev tag only (no version tags on devel branch)
          docker build --no-cache -t ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG .
          docker push ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG

          # Logout
          docker logout

      - name: Update Docker Hub README
        if: success() && vars.DOCKERHUB_USERNAME
        run: |
          cd /home/ted/photography-website/

          # Read README.md and escape for JSON
          README_CONTENT=$(cat README.md | jq -Rs .)

          # Get authentication token
          TOKEN=$(curl -s -X POST \
            'https://hub.docker.com/v2/users/login/' \
            -H 'Content-Type: application/json' \
            -d "{\"username\": \"${{ vars.DOCKERHUB_USERNAME }}\", \"password\": \"${{ secrets.DOCKERHUB_TOKEN }}\"}" \
            | jq -r .token)

          # Update Docker Hub repository description
          curl -X PATCH \
            "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}/" \
            -H "Authorization: JWT $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"full_description\": $README_CONTENT}" \
            --silent --output /dev/null || true

      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TAG="${{ vars.DOCKER_TAG }}"
          if [ -z "$TAG" ]; then
            TAG="dev"
          fi

          MESSAGE="üê≥ Docker image built and pushed!

          üåê Branch: devel
          üì¶ Image: ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)

          MESSAGE="‚ùå Docker build FAILED!

          üåê Branch: devel
          üì¶ Commit: $COMMIT_HASH

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true
