name: Update Prod VM

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      build_docker:
        description: 'Build and push Docker image'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Run update.sh on prod VM
    runs-on: [self-hosted, prod, photography-website]
    environment: Prod
    steps:
      - name: Pull latest changes from GitHub
        run: |
          cd /home/ted/photography-website/
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          git pull --ff-only origin "$CURRENT_BRANCH"

      - name: Send deployment start notification
        if: vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="üîÑ Starting deployment...

          üåê Branch: master
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Run deployment script
        run: |
          cd /home/ted/photography-website/
          ./restart.sh

      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="‚úÖ Photography Website deployed successfully!

          üåê Branch: master
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="‚ùå Photography Website deployment FAILED!

          üåê Branch: master
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          ‚ö†Ô∏è PRODUCTION DEPLOYMENT FAILED - URGENT!

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true
  
  docker:
    name: Build and push Docker image
    runs-on: [self-hosted, prod, photography-website]
    environment: Prod
    needs: deploy
    if: github.event.inputs.build_docker == 'true'
    steps:
      - name: Build and push Docker image
        if: vars.DOCKERHUB_USERNAME && vars.DOCKER_IMAGE_NAME
        run: |
          cd /home/ted/photography-website/
          
          # Login to Docker Hub
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ vars.DOCKERHUB_USERNAME }}" --password-stdin
          
          # Set tag (use environment variable or default to 'latest')
          TAG="${{ vars.DOCKER_TAG }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi
          
          # Build and push
          docker build -t ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG .
          docker push ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG
          
          # Also tag and push with commit hash
          COMMIT_HASH=$(git rev-parse --short HEAD)
          docker tag ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG \
                     ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$COMMIT_HASH
          docker push ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$COMMIT_HASH
          
          # Logout
          docker logout
      
      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TAG="${{ vars.DOCKER_TAG }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi
          
          MESSAGE="üê≥ Docker image built and pushed!

          üåê Branch: master
          üì¶ Image: ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG
          üè∑Ô∏è Also tagged: $COMMIT_HASH
          
          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true
      
      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          MESSAGE="‚ùå Docker build FAILED!

          üåê Branch: master
          üì¶ Commit: $COMMIT_HASH
          
          ‚ö†Ô∏è PRODUCTION DOCKER BUILD FAILED!
          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true
