name: Update Prod VM

on:
  push:
    branches: [master]

jobs:
  deploy:
    name: Run update.sh on prod VM
    runs-on: [self-hosted, prod, photography-website]
    environment: Prod
    steps:
      - name: Pull latest changes from GitHub
        run: |
          cd /home/ted/photography-website/
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          git pull --ff-only origin "$CURRENT_BRANCH"

      - name: Send deployment start notification
        if: vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="ğŸ”„ Starting deployment...

          ğŸŒ Branch: master
          ğŸ”— URL: ${{ vars.SITE_URL || '' }}
          ğŸ“¦ Commit: $COMMIT_HASH
          ğŸ’¬ $COMMIT_MSG

          ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Run deployment script
        run: |
          cd /home/ted/photography-website/
          ./restart.sh

      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="âœ… Photography Website deployed successfully!

          ğŸŒ Branch: master
          ğŸ”— URL: ${{ vars.SITE_URL || '' }}
          ğŸ“¦ Commit: $COMMIT_HASH
          ğŸ’¬ $COMMIT_MSG

          ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="âŒ Photography Website deployment FAILED!

          ğŸŒ Branch: master
          ğŸ”— URL: ${{ vars.SITE_URL || '' }}
          ğŸ“¦ Commit: $COMMIT_HASH
          ğŸ’¬ $COMMIT_MSG

          âš ï¸ PRODUCTION DEPLOYMENT FAILED - URGENT!

          ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true
