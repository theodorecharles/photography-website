name: Update Prod VM

on:
  push:
    branches: [master]

jobs:
  deploy:
    name: Run update.sh on prod VM
    runs-on: [self-hosted, prod, photography-website]
    steps:
      - name: Pull latest changes from GitHub
        run: |
          cd /home/ted/photography-website/
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          git pull --ff-only origin "$CURRENT_BRANCH"
      
      - name: Run deployment script
        run: |
          cd /home/ted/photography-website/
          ./restart.sh
      
      - name: Send failure notification
        if: failure()
        run: |
          cd /home/ted/photography-website/
          
          # Read Telegram config
          TELEGRAM_ENABLED=$(jq -r '.notifications.telegram.enabled // false' data/config.json)
          
          if [ "$TELEGRAM_ENABLED" = "true" ]; then
            TELEGRAM_BOT_TOKEN=$(jq -r '.notifications.telegram.botToken // ""' data/config.json)
            TELEGRAM_CHAT_ID=$(jq -r '.notifications.telegram.chatId // ""' data/config.json)
            SITE_URL=$(jq -r '.environment.backend.allowedOrigins[0] // ""' data/config.json)
            COMMIT_HASH=$(git rev-parse --short HEAD)
            COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
            
            if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
              MESSAGE="‚ùå GitHub Actions FAILED on production!

          üåê Branch: master
          üîó URL: $SITE_URL
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG
          
          ‚ö†Ô∏è PRODUCTION DEPLOYMENT FAILED - URGENT!
          Check GitHub Actions for details."
              
              curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                   -d "chat_id=${TELEGRAM_CHAT_ID}" \
                   -d "text=$MESSAGE" \
                   --silent --output /dev/null || true
            fi
          fi
