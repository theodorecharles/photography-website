name: Update Prod VM

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      build_docker:
        description: "Build and push Docker image"
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Run update.sh on prod VM
    runs-on: [self-hosted, prod, photography-website]
    environment: Prod
    steps:
      - name: Pull latest changes from GitHub
        run: |
          cd /home/ted/photography-website/
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          git fetch origin "$CURRENT_BRANCH"
          git reset --hard "origin/$CURRENT_BRANCH"

      - name: Send deployment start notification
        if: vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="üîÑ Starting deployment...

          üåê Branch: master
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Run deployment script
        run: |
          cd /home/ted/photography-website/
          ./restart.sh

      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="‚úÖ Photography Website deployed successfully!

          üåê Branch: master
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        run: |
          cd /home/ted/photography-website/
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)

          MESSAGE="‚ùå Photography Website deployment FAILED!

          üåê Branch: master
          üîó URL: ${{ vars.SITE_URL || '' }}
          üì¶ Commit: $COMMIT_HASH
          üí¨ $COMMIT_MSG

          ‚ö†Ô∏è PRODUCTION DEPLOYMENT FAILED - URGENT!

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d "chat_id=${{ vars.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    environment: Docker-Build-Prod
    needs: deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Docker build start notification
        if: vars.TELEGRAM_CHAT_ID
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)

          MESSAGE="üê≥ Docker build starting...

          üåê Branch: master
          üì¶ Commit: $COMMIT_HASH

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -d "chat_id=${TELEGRAM_CHAT_ID}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get version from package.json
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        if: vars.DOCKERHUB_USERNAME && vars.DOCKER_IMAGE_NAME
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ vars.DOCKER_TAG || 'latest' }}
            ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:v${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update Docker Hub README
        if: success() && vars.DOCKERHUB_USERNAME
        run: |
          # Read README.md and escape for JSON
          README_CONTENT=$(cat README.md | jq -Rs .)

          # Get authentication token
          TOKEN=$(curl -s -X POST \
            'https://hub.docker.com/v2/users/login/' \
            -H 'Content-Type: application/json' \
            -d "{\"username\": \"${{ vars.DOCKERHUB_USERNAME }}\", \"password\": \"${{ secrets.DOCKERHUB_TOKEN }}\"}" \
            | jq -r .token)

          # Update Docker Hub repository description
          curl -X PATCH \
            "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}/" \
            -H "Authorization: JWT $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"full_description\": $README_CONTENT}" \
            --silent --output /dev/null || true

      - name: Send success notification
        if: success() && vars.TELEGRAM_CHAT_ID
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TAG="${{ vars.DOCKER_TAG }}"
          if [ -z "$TAG" ]; then
            TAG="latest"
          fi

          VERSION="${{ steps.version.outputs.version }}"

          MESSAGE="üê≥ Docker image built and pushed!

          üåê Branch: master
          üì¶ Image: ${{ vars.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:$TAG
          üè∑Ô∏è Also tagged: v$VERSION

          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -d "chat_id=${TELEGRAM_CHAT_ID}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true

      - name: Send failure notification
        if: failure() && vars.TELEGRAM_CHAT_ID
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)

          MESSAGE="‚ùå Docker build FAILED!

          üåê Branch: master
          üì¶ Commit: $COMMIT_HASH

          ‚ö†Ô∏è PRODUCTION DOCKER BUILD FAILED!
          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
               -d "chat_id=${TELEGRAM_CHAT_ID}" \
               -d "text=$MESSAGE" \
               --silent --output /dev/null || true
