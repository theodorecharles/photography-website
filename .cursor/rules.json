{
  "projectOverview": {
    "description": "Photography portfolio website with React 19, TypeScript, Express 5, SQLite",
    "architecture": "Monorepo with separate frontend and backend. SQLite for data, filesystem for photos",
    "deployment": "PM2 for production, separate dev servers for development"
  },
  "development": {
    "serverManagement": {
      "development": "DO NOT use PM2 for development. Run backend and frontend separately: 'cd backend && npm run dev' and 'cd frontend && npm run dev'",
      "production": "PM2 is used for production only. Use './restart.sh' or 'pm2 start ecosystem.config.js'"
    },
    "buildProcess": {
      "backend": "Backend changes require 'npm run build' to compile TypeScript before deployment",
      "frontend": "Frontend uses Vite for fast HMR in development"
    }
  },
  "criticalPatterns": {
    "databaseFirst": {
      "rule": "ALWAYS query SQLite database instead of scanning filesystem",
      "rationale": "Filesystem scans are slow and don't scale. Use image_metadata table for images, albums table for albums",
      "examples": [
        "Use getImagesInAlbum(album) instead of fs.readdirSync()",
        "Use getAllAlbums() instead of scanning photos directory",
        "Use getImagesFromPublishedAlbums() for published content"
      ],
      "exceptions": "Only scan filesystem when syncing new uploads to database"
    },
    "sseRaceConditions": {
      "rule": "For SSE (Server-Sent Events) endpoints, create job tracking IMMEDIATELY after checking if job exists",
      "rationale": "Prevents race condition where two simultaneous requests both think no job exists and spawn duplicate processes",
      "pattern": "Check if job exists → Create job object → Set headers → Spawn process",
      "files": ["backend/src/routes/ai-titles.ts", "backend/src/routes/image-optimization.ts"],
      "antipattern": "Never set headers or start any work before creating the job tracking object"
    },
    "sseBroadcasting": {
      "rule": "SSE handlers must broadcast to ALL connected clients and store output history",
      "rationale": "Multiple clients can connect/reconnect. All must receive updates and see previous output",
      "pattern": [
        "Store output in job.output array",
        "Use broadcastToClients(job, message) for all output (stdout, stderr, errors)",
        "Never write directly to a single res object in data handlers"
      ],
      "files": ["backend/src/routes/ai-titles.ts", "backend/src/routes/image-optimization.ts"]
    },
    "sseTimeouts": {
      "rule": "SSE connections must disable response timeouts and proxy buffering",
      "rationale": "Prevents network timeout errors on long-running operations (uploads, optimization, AI generation)",
      "pattern": [
        "res.setHeader('X-Accel-Buffering', 'no') to disable proxy buffering",
        "res.setTimeout(0) to disable response timeout",
        "Apply to ALL SSE endpoints immediately after setting other headers"
      ],
      "files": ["backend/src/routes/ai-titles.ts", "backend/src/routes/image-optimization.ts", "backend/src/routes/album-management.ts"]
    },
    "authentication": {
      "rule": "Use requireAuth middleware for all admin endpoints",
      "implementation": "req.isAuthenticated() checks if user is logged in via Google OAuth",
      "files": "All routes in backend/src/routes/ except public endpoints (albums, photos, sitemap, health)"
    },
    "csrfProtection": {
      "rule": "Apply csrfProtection middleware to all routes that modify data",
      "implementation": "router.use(csrfProtection) at top of route file",
      "exception": "Read-only GET endpoints don't need CSRF protection",
      "files": "All routes with POST, PUT, DELETE methods"
    },
    "pathSanitization": {
      "rule": "ALWAYS sanitize user-provided paths to prevent directory traversal",
      "pattern": "Use sanitizePath() helper that blocks '..' and path separators",
      "critical": "Album names, filenames, and any path components from user input",
      "files": ["backend/src/routes/albums.ts", "backend/src/routes/album-management.ts"]
    }
  },
  "architecturePatterns": {
    "database": {
      "description": "SQLite with better-sqlite3 for synchronous operations",
      "location": "backend/src/database.ts",
      "tables": {
        "albums": "Album names and published state",
        "image_metadata": "Image filenames, titles, descriptions, sort_order per album",
        "share_links": "Shareable album links with secret keys and expiration"
      },
      "performance": [
        "WAL mode enabled for better concurrency",
        "Indexes on (album, filename)",
        "Prepared statements for all queries"
      ],
      "migrations": "Run migrate-database.js when schema changes"
    },
    "imageOptimization": {
      "sizes": ["thumbnail (512px)", "modal (2048px)", "download (4096px)"],
      "location": "optimized/ directory with subdirs for each size and album",
      "process": "optimize_all_images.js runs via SSE endpoint, tracks progress",
      "onUpload": "New images auto-optimized during upload via album-management route"
    },
  "staticJSON": {
    "description": "Pre-generated JSON files for faster page loads (optional performance optimization)",
    "location": "frontend/public/albums-data/",
    "format": "Optimized array format: [[filename, title], ...] for albums, [[filename, title, album], ...] for homepage",
    "optimization": "83% smaller than verbose object format (Wedding Photos: 582KB → 100KB)",
    "generation": "scripts/generate-static-json.js creates JSON for all albums + homepage",
    "reconstruction": "PhotoGrid.tsx reconstructs full photo objects with reconstructPhoto() function",
    "gitIgnored": "Yes - these are generated files, not version controlled",
    "fallback": "Frontend falls back to API if static JSON doesn't exist",
    "deployment": "Automatically generated by restart.sh after deployment",
    "networkTransfer": "Gzipped: 26.6 KB → 11.8 KB (56% reduction)",
    "caching": "In-memory cache on frontend server (5-minute TTL, X-Cache header)"
  },
    "asyncJobs": {
      "pattern": "Long-running jobs (AI titles, optimization) use child_process.spawn with SSE streaming",
      "tracking": "runningJobs object tracks active processes, output history, connected clients",
      "features": [
        "Multiple clients can connect/reconnect to same job",
        "Stop button sends SIGTERM to process",
        "Jobs auto-cleanup 5 minutes after completion"
      ],
      "files": ["backend/src/routes/ai-titles.ts", "backend/src/routes/image-optimization.ts"]
    },
    "caching": {
      "albumPhotos": "5-minute in-memory cache for album photo lists",
      "invalidation": "Cache cleared on image upload/delete via invalidateAlbumCache()",
      "file": "backend/src/routes/albums.ts"
    }
  },
  "apiEndpoints": {
    "public": [
      "GET /api/albums - List albums (filtered by published state)",
      "GET /api/albums/:album/photos - Get photos in album",
      "GET /api/random-photos - Shuffled photos from published albums",
      "GET /api/photos/:album/:filename/exif - EXIF data",
      "GET /api/shared/:secretKey - View shared album (public access)",
      "GET /api/preview-grid/shared/:secretKey - 2x2 preview for shared album",
      "GET /sitemap.xml - SEO sitemap",
      "GET /api/health - Health check"
    ],
    "authenticated": [
      "POST /api/ai-titles/generate - Generate AI titles (SSE)",
      "POST /api/ai-titles/stop - Stop AI generation",
      "POST /api/image-optimization/optimize - Run optimization (SSE)",
      "POST /api/albums/upload - Upload photos",
      "POST /api/album-management/albums - Create/rename/delete albums",
      "PUT /api/album-management/albums/:album/publish - Toggle published state",
      "POST /api/album-management/:album/share - Create share link",
      "DELETE /api/album-management/share/:shareId - Delete share link",
      "All /api/analytics/* - Analytics queries",
      "All /api/branding/* - Branding config",
      "All /api/config/* - Site config"
    ]
  },
  "security": {
    "rules": [
      "Never trust user input - sanitize all paths and filenames",
      "Use parameterized SQL queries to prevent injection",
      "Validate file types before processing uploads",
      "CSRF tokens required for all state-changing operations",
      "Email whitelist for Google OAuth (authorizedEmails in config)",
      "Rate limiting on upload endpoints"
    ]
  },
  "testing": {
    "beforeCommit": [
      "Test SSE endpoints with multiple simultaneous connections",
      "Verify database queries work with empty database",
      "Check CSRF tokens are sent/validated on protected routes",
      "Test path sanitization with malicious inputs",
      "Verify published/unpublished album filtering"
    ]
  },
  "commonPitfalls": {
    "filesystemScans": "Never use fs.readdirSync() in route handlers - use database queries",
    "raceConditions": "SSE job creation must happen before any async work",
    "singleClient": "Don't write to 'res' directly in child process handlers - use broadcast",
    "cacheStaleness": "Remember to invalidate album cache when images change",
    "missingAuth": "Don't forget requireAuth middleware on admin endpoints",
    "directFilesystemAccess": "Photos stored in filesystem, metadata in database - keep in sync",
    "sseTimeouts": "Always disable timeouts on SSE responses with res.setTimeout(0)",
    "mapTiles": "Use correct CartoDB tile URL format without {r} placeholder"
  },
  "uiPatterns": {
    "passwordInput": {
      "rule": "Use PasswordInput component for all password/secret fields",
      "features": ["Eye toggle for visibility", "Copy to clipboard button", "Ref forwarding support"],
      "location": "frontend/src/components/AdminPortal/PasswordInput.tsx",
      "usage": "Replace type='password' inputs with <PasswordInput /> in settings pages"
    },
    "visitorMap": {
      "provider": "CartoDB dark_all tiles via Leaflet",
      "url": "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
      "note": "Do not use {r} placeholder in tile URL - it causes black screen",
      "subdomains": ["a", "b", "c", "d"],
      "location": "frontend/src/components/AdminPortal/Metrics/VisitorMap.tsx"
    }
  },
  "bundleSplitting": {
    "description": "Vite with manual chunk splitting for optimal performance",
    "configuration": {
      "react-vendor": "react, react-dom, react-router-dom (45 KB gzipped)",
      "recharts-vendor": "recharts charting library (92 KB gzipped)",
      "admin-vendor": "@dnd-kit/*, leaflet, react-leaflet (61 KB gzipped)"
    },
    "results": {
      "initialLoad": "44 KB gzipped (69% reduction from 198 KB)",
      "adminLoad": "Admin dependencies lazy loaded only when accessing admin panel"
    },
    "lazyComponents": ["AdminPortal", "License", "AuthError", "NotFound", "SharedAlbum"],
    "file": "frontend/vite.config.ts"
  },
  "componentRefactoring": {
    "ConfigManager": {
      "structure": "Modular sections pattern (was 3,781 lines monolithic)",
      "orchestrator": "index.tsx manages global state, SSE connections, confirmation modal",
      "sections": [
        "BrandingSection.tsx - Site name, logo, colors (460 lines)",
        "LinksSection.tsx - External links management (258 lines)",
        "OpenAISection.tsx - AI configuration (421 lines)",
        "ImageOptimizationSection.tsx - Image processing settings (493 lines)",
        "AdvancedSettingsSection.tsx - System controls, operations (1,305 lines)"
      ],
      "pattern": "Each section manages own state, orchestrator handles cross-cutting concerns"
    },
    "AlbumsManager": {
      "structure": "Orchestrator + reusable components (was 2,249 lines)",
      "orchestrator": "index.tsx keeps tightly coupled state (DND, SSE, uploads)",
      "components": [
        "SortableAlbumCard.tsx - Album card with drag-drop (126 lines)",
        "SortablePhotoItem.tsx - Photo thumbnail with drag-drop (172 lines)"
      ],
      "rationale": "Further splitting would cause prop drilling hell due to tight state coupling"
    },
    "refactoringPrinciples": [
      "Extract shared types to types.ts",
      "Extract reusable UI components",
      "Keep tightly coupled state in orchestrator",
      "Sections manage their own state when independent",
      "Balance modularity vs coupling - don't over-split"
    ]
  },
  "mobileUX": {
    "breakpoint": "768px for mobile-specific styles",
    "hiddenOnMobile": [
      "Edit buttons in header (< 768px)",
      "Logout button (< 768px)",
      "Config section descriptions (< 768px)"
    ],
    "sseToaster": {
      "desktop": "Draggable, snaps to corners, slide-in animations",
      "mobile": "Centered bottom, no dragging, no animations (prevents jumping)",
      "implementation": "animation: none !important, transform: translateX(-50%) !important"
    },
    "principles": [
      "Remove duplicate UI elements",
      "Simplify navigation",
      "Center-align critical UI",
      "Disable animations causing jumpy behavior",
      "Test on < 600px viewport"
    ]
  },
  "documentation": {
    "rules": {
      "DO": [
        "Update .cursor/rules.json with architectural decisions",
        "Add inline comments for complex logic",
        "Document API endpoints in this file"
      ],
      "DONT": [
        "Create separate markdown documentation files",
        "Write summaries of work done (update rules instead)",
        "Leave TODO comments without issue tracking"
      ]
    },
    "rationale": "Centralized rules are easier to maintain and search than scattered markdown files"
  },
  "performanceTargets": {
    "lighthouse": "> 90 score",
    "initialLoad": "< 50 KB gzipped (currently 44 KB)",
    "timeToInteractive": "< 2s on 4G",
    "mainChunk": "< 150 KB uncompressed (currently 124 KB)",
    "firstPaint": "< 1s for large albums (batched rendering)"
  },
  "batchedRendering": {
    "description": "Optimize first paint for large albums by rendering photos in batches",
    "threshold": "Albums with > 50 photos",
    "strategy": [
      "Load all photo metadata from JSON instantly",
      "Render first 50 photos to DOM immediately (fast initial paint)",
      "Batch-add remaining photos in 50-photo chunks every 100ms",
      "Show progress indicator during background loading"
    ],
    "benefits": [
      "First paint in ~0.5s instead of 5s for 930-photo albums",
      "Page is interactive immediately",
      "No janky scroll-based loading",
      "Works with both static JSON and API fallback"
    ],
    "file": "frontend/src/components/PhotoGrid.tsx"
  },
  "deprecatedRules": {
    "note": "The old component-specific rules are removed. Focus on backend architecture patterns which are more critical and harder to debug."
  }
}
