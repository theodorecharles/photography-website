# Database Migration Rules

## Critical: Database Structure Changes
**ANY time changes are made to the database structure (tables, columns, indexes, etc.), you MUST:**

1. **Create a migration script** in the project root (e.g., `migrate-add-feature-name.js`)
   - Script must check if changes already exist before applying
   - Script must be idempotent (safe to run multiple times)
   - Script must provide clear console output about what it's doing
   - Script must handle errors gracefully

2. **Update restart.sh** to run the migration automatically
   - Add the migration to the list of migrations that run on deployment
   - Migrations should run BEFORE starting the application
   - Ensure migrations run in the correct order if dependencies exist

3. **Document the migration** in the commit message
   - Clearly state what database changes were made
   - Note any data transformations or migrations
   - Include rollback instructions if applicable

## Example Migration Script Template
```javascript
#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { createRequire } from 'module';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const require = createRequire(import.meta.url);
const Database = require('better-sqlite3');
const DB_PATH = path.join(__dirname, 'gallery.db');

console.log('Starting [feature name] migration...');

if (!fs.existsSync(DB_PATH)) {
  console.error('❌ Error: gallery.db not found.');
  process.exit(1);
}

const db = new Database(DB_PATH);
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
db.pragma('foreign_keys = ON');

try {
  // Check if migration already applied
  const tableInfo = db.pragma('table_info(table_name)');
  const hasColumn = tableInfo.some((col) => col.name === 'column_name');
  
  if (!hasColumn) {
    console.log('✓ Applying migration...');
    db.exec(`ALTER TABLE table_name ADD COLUMN column_name TYPE`);
    console.log('✓ Migration completed successfully!');
  } else {
    console.log('✓ Migration already applied, skipping');
  }
} catch (error) {
  console.error('❌ Migration failed:', error);
  process.exit(1);
} finally {
  db.close();
}
```

## Restart Script Requirements
The `restart.sh` script must run all migrations in order before starting the app:
```bash
# Run migrations
echo "Running database migrations..."
node migrate-add-feature1.js || exit 1
node migrate-add-feature2.js || exit 1
```

## Never Do These Things
- ❌ Don't modify database structure directly without a migration script
- ❌ Don't skip adding migrations to restart.sh
- ❌ Don't create migrations that aren't idempotent
- ❌ Don't forget to test migrations with existing data
- ❌ Don't commit database changes without corresponding migration script

